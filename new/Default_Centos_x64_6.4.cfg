# Kickstart file automatically generated by anaconda.
# modified for our base install

install
network --bootproto=dhcp --nodns --noipv6
nfs --server=10.51.8.4 --dir=/kickstart/os/Centos/6.4_x86_x64/patched
#repo --name=epel --baseurl=http://download.fedoraproject.org/pub/epel/6/x86_64/ --proxy=http://=10.51.8.4:3128
lang en_GB.UTF-8
keyboard uk
skipx
text

rootpw --iscrypted $1$j6Uo0vMi$T9GMZqS7FhxAkCDa2omly/
# add standard account (me)
user --name=cscott --groups=root --password=letmein --shell=/bin/bash --uid=1087


firewall --disabled
selinux --disabled
authconfig --enableshadow --enablemd5 
timezone --utc Europe/London

zerombr yes
bootloader --location=mbr

# get disk layout - generated by %pre
%include /tmp/part-include





#reboot

%packages 
@English (UK) Support
@Core
@Base
-cups
-cups-libs
-procmail
-spamassassin
nfs-utils
nmap
redhat-lsb
# needed by hp stuff amongst other bits
glib2
glibc.i686
glibc-devel
glibc-headers
libgcc
libstdc++
libXxf86misc
nss
nss-softokn
nss-softokn-freebl.i686
gcc
libnl-devel
# for bmon
rrdtool
iptraf
ltrace
gd      
graphviz  
libXaw      
libXmu       
libXpm        
lm_sensors-libs
net-snmp-libs 
libacl.i686
libstdc++.i686 
libattr.i686
screen




%pre


# pre section
#----- partitioning logic below--------------
# pick the first drive that is not removable and is over MINSIZE
DIR="/sys/block"

# minimum size of hard drive needed specified in GIGABYTES
MINSIZE=4

ROOTDRIVE=""

# /sys/block/*/size is in 512 byte chunks

for DEV in sda hda ; do
  if [ -d $DIR/$DEV ]; then
    REMOVABLE=`cat $DIR/$DEV/removable`
    if (( $REMOVABLE == 0 )); then
      echo $DEV
      SIZE=`cat $DIR/$DEV/size`
      GB=$(($SIZE/2**21))
      if [ $GB -gt $MINSIZE ]; then
        echo "$(($SIZE/2**21))"
        if [ -z $ROOTDRIVE ]; then
          ROOTDRIVE=$DEV
        fi
      fi
    fi
  fi
done

echo "ROOTDRIVE=$ROOTDRIVE"

# drives smaller than 240GB use fixed-size partions
# drives larger than 240GB use percentage-based partition sizes

dd if=/dev/zero of=/dev/$ROOTDRIVE bs=1M count=10

if [ $GB -lt 17 ]; then

# drives smaller than 16GB
cat << EOF > /tmp/part-include
zerombr
clearpart --all --initlabel
bootloader --location=mbr --driveorder=$ROOTDRIVE

part /boot --fstype "ext4" --size=512 --ondisk=$ROOTDRIVE --asprimary
part pv.01 --size=1 --grow --ondisk=$ROOTDRIVE --asprimary
volgroup vg_system pv.01
 
logvol  / --vgname=vg_system --fstype ext4 --size=2048 --grow --maxsize=8192 --name=lv_root
logvol  /home --vgname=vg_system --fstype ext4  --size=64 --grow --maxsize=512  --name=lv_home
logvol  /var --vgname=vg_system --fstype ext4  --size=256 --grow --maxsize=3072  --name=lv_var
logvol  /tmp --vgname=vg_system  --fstype ext4 --size=64 --grow --maxsize=512  --name=lv_tmp
logvol  /opt  --vgname=vg_system --fstype ext4  --size=256 --grow --maxsize=2048 --name=lv_opt
logvol  swap --fstype swap --vgname=vg_system  --size=256 --grow --maxsize=2048  --name=lv_swap

EOF

else


# drives bigger than 16GB
cat << EOF > /tmp/part-include

zerombr
clearpart --all --initlabel
part /boot --fstype "ext4" --size=512 --ondisk=$ROOTDRIVE --asprimary
part pv.01 --size=1 --grow --ondisk=$ROOTDRIVE --asprimary
volgroup vg_system pv.01

logvol  / --vgname=vg_system --fstype ext4 --size=8192  --name=lv_root
logvol  /home --vgname=vg_system --fstype ext4  --size=1024 --grow --maxsize=4096 --name=lv_home
logvol  /var --vgname=vg_system --fstype ext4  --size=4096 --grow --maxsize=8192  --name=lv_var
logvol  /tmp --vgname=vg_system  --fstype ext4 --size=1024 --grow --maxsize=2048  --name=lv_tmp
logvol  /opt  --vgname=vg_system --fstype ext4  --size=1024 --grow --maxsize=8192 --name=lv_opt
logvol  swap --fstype swap --vgname=vg_system  --size=1024 --grow --maxsize=8192  --name=lv_swap

EOF

fi

if [ -e /dev/sdb ]  ; then
dd if=/dev/zero of=/dev/sdb bs=1M count=10

cat << EOF >> /tmp/part-include

bootloader --location=mbr --driveorder=$ROOTDRIVE,sdb
part /adv365_rescue/boot --fstype "ext4" --size=512 --ondisk=sdb --asprimary
part pv.02 --size=1 --grow --ondisk=sdb --asprimary
volgroup vg_swap pv.02
logvol  swap --fstype swap --vgname=vg_swap  --size=1024  --name=lv_swap2
logvol  /adv365_rescue --fstype ext4 --vgname=vg_swap  --size=2048  --name=lv_adv365_resq

EOF

else
cat << EOF >> /tmp/part-include
bootloader --location=mbr --driveorder=$ROOTDRIVE

EOF

fi


if [ -e /dev/sdc ]  ; then
dd if=/dev/zero of=/dev/sdc bs=1M count=10
cat << EOF >> /tmp/part-include

part pv.03 --size=1 --grow --ondisk=sdc --asprimary
volgroup vg_data pv.03
logvol  /data  --vgname=vg_data --fstype ext4  --size=256  --name=lv_data

EOF

fi






#### 
%post --log=/root/ks-post.log

/bin/rpm --import /usr/share/rhn/RPM-GPG-KEY*
/bin/rpm -e comps

#portmap


mkdir -p /mnt/nfs
mount -o ro -t nfs 10.51.8.4:/kickstart /mnt/nfs
#open -s -w -- /mnt/nfs/scripts/finish/default_finish_CentOS 2>&1 | tee /root/ks-script.log
/mnt/nfs/scripts/finish/default_finish_CentOS 2>&1 | tee /root/ks-script.log

#yum groupinstall core --installroot=/adv365/rescue --nogpgcheck -y
#yum install plymouth libselinux-python kernel --installroot=/adv365/rescue --nogpgcheck -y

#rsync -aH /mnt/sysimage/ /mnt/sysimage/


#sleep 300

